<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111111">
    <title>Retro Asteroids 8-Bit</title>
    
    <!-- PWA Linkages -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #111;
            color: #fff;
            overflow: hidden;
            font-family: 'Press Start 2P', monospace; /* Retro font */
            touch-action: none; /* Prevent browser zooming/scrolling */
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            background-color: #000;
            image-rendering: pixelated; /* 8-bit sharp edges */
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
            border: 2px solid #333;
        }

        /* UI Overlays */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        #score-board {
            padding: 20px;
            font-size: 16px;
            color: #fff;
            text-shadow: 2px 2px #000;
            pointer-events: none;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border: 4px solid #fff;
            pointer-events: auto;
            z-index: 10;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            color: #4ade80; /* Retro Green */
            text-shadow: 4px 4px #000;
        }

        p {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 20px;
            color: #ccc;
        }

        button.btn {
            background: #fff;
            color: #000;
            border: 4px solid #4ade80;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            transition: transform 0.1s;
        }

        button.btn:active {
            transform: scale(0.95);
            background: #4ade80;
        }

        .hidden {
            display: none !important;
        }

        /* Touch Controls */
        #controls {
            pointer-events: auto;
            display: none; /* Hidden on desktop by default, shown via JS if touch detected or always on mobile */
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            justify-content: space-between;
            align-items: flex-end;
            padding-bottom: 40px;
        }

        .d-pad, .action-pad {
            display: flex;
            gap: 15px;
        }

        .touch-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
            color: #fff;
            touch-action: manipulation;
        }

        .touch-btn:active, .touch-btn.active {
            background: rgba(74, 222, 128, 0.5);
            border-color: #4ade80;
        }

        /* Make controls visible on small screens automatically */
        @media (max-width: 768px) {
            #controls {
                display: flex;
            }
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span> | LIVES: <span id="lives-val">3</span></div>
        
        <!-- Touch Controls -->
        <div id="controls">
            <div class="d-pad">
                <div class="touch-btn" id="btn-left">←</div>
                <div class="touch-btn" id="btn-right">→</div>
            </div>
            <div class="action-pad">
                <div class="touch-btn" id="btn-shoot">●</div>
                <div class="touch-btn" id="btn-thrust">▲</div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1>SQUARE BLASTER</h1>
        <p>Use Arrow Keys to Move<br>Space to Shoot</p>
        <p style="font-size: 10px; color: #888;">(Or touch controls on mobile)</p>
        <button class="btn" id="start-btn">START GAME</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over-screen" class="hidden">
        <h1 style="color: #ef4444;">GAME OVER</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button class="btn" id="restart-btn">TRY AGAIN</button>
    </div>
</div>

<script>
// --- PWA Service Worker Registration ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker failed', err));
    });
}

// --- Audio System ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    if (type === 'shoot') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(880, now);
        osc.frequency.exponentialRampToValueAtTime(110, now + 0.15);
        gain.gain.setValueAtTime(0.3, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        osc.start(now);
        osc.stop(now + 0.15);
    } 
    else if (type === 'thrust') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.linearRampToValueAtTime(50, now + 0.1);
        gain.gain.setValueAtTime(0.2, now);
        gain.gain.linearRampToValueAtTime(0.01, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    }
    else if (type === 'explosion') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(100, now);
        osc.frequency.exponentialRampToValueAtTime(1, now + 0.3);
        gain.gain.setValueAtTime(0.5, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.start(now);
        osc.stop(now + 0.3);
    }
}

// --- Game Engine ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreVal = document.getElementById('score-val');
const livesVal = document.getElementById('lives-val');
const startScreen = document.getElementById('start-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const finalScore = document.getElementById('final-score');

let animationId, lastTime = 0, score = 0, lives = 3, level = 1;
let gameState = 'start'; 

const FPS = 60, FRICTION = 0.98, SHIP_THRUST = 0.15, SHIP_TURN_SPEED = 5, BULLET_SPEED = 8, ASTEROID_SPEED = 1.5;

const keys = { ArrowUp: false, ArrowLeft: false, ArrowRight: false, Space: false };
const touchState = { left: false, right: false, thrust: false, shoot: false };

let ship = {}, asteroids = [], bullets = [], particles = [];

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

window.addEventListener('keydown', e => {
    if (e.code === 'ArrowUp' || e.code === 'KeyW') keys.ArrowUp = true;
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = true;
    if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = true;
    if (e.code === 'Space' && gameState === 'playing') { keys.Space = true; shoot(); }
});

window.addEventListener('keyup', e => {
    if (e.code === 'ArrowUp' || e.code === 'KeyW') keys.ArrowUp = false;
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.ArrowLeft = false;
    if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.ArrowRight = false;
    if (e.code === 'Space') keys.Space = false;
});

function setupTouchBtn(id, key) {
    const btn = document.getElementById(id);
    const start = (e) => { e.preventDefault(); touchState[key] = true; btn.classList.add('active'); if(key === 'shoot') shoot(); };
    const end = (e) => { e.preventDefault(); touchState[key] = false; btn.classList.remove('active'); };
    btn.addEventListener('mousedown', start); btn.addEventListener('mouseup', end); btn.addEventListener('mouseleave', end);
    btn.addEventListener('touchstart', start, {passive: false}); btn.addEventListener('touchend', end, {passive: false});
}
setupTouchBtn('btn-left', 'left'); setupTouchBtn('btn-right', 'right');
setupTouchBtn('btn-thrust', 'thrust'); setupTouchBtn('btn-shoot', 'shoot');

function createShip() {
    return { x: canvas.width / 2, y: canvas.height / 2, r: 15, a: -Math.PI / 2, xv: 0, yv: 0, thrusting: false, blinkNum: 0, explodeTime: 0 };
}

function createAsteroid(x, y, r) {
    const speed = (Math.random() * ASTEROID_SPEED + 0.5) * (1 + level * 0.1); 
    const angle = Math.random() * Math.PI * 2;
    return { x: x, y: y, xv: Math.cos(angle) * speed, yv: Math.sin(angle) * speed, r: r, a: Math.random() * Math.PI * 2 };
}

function createBullet(x, y, angle) {
    return { x: x, y: y, xv: Math.cos(angle) * BULLET_SPEED, yv: Math.sin(angle) * BULLET_SPEED, dist: 0, maxDist: canvas.width * 0.8 };
}

function createParticle(x, y, color) {
    const angle = Math.random() * Math.PI * 2, speed = Math.random() * 3 + 1;
    return { x: x, y: y, xv: Math.cos(angle) * speed, yv: Math.sin(angle) * speed, life: 1.0, decay: Math.random() * 0.05 + 0.02, color: color || '#fff', size: Math.random() * 4 + 2 };
}

function spawnAsteroids(amount) {
    asteroids = []; bullets = [];
    for (let i = 0; i < amount; i++) {
        let x, y;
        do { x = Math.floor(Math.random() * canvas.width); y = Math.floor(Math.random() * canvas.height); } 
        while (distBetweenPoints(ship.x, ship.y, x, y) < 150);
        asteroids.push(createAsteroid(x, y, 40));
    }
}

function distBetweenPoints(x1, y1, x2, y2) { return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)); }

function shoot() {
    if (gameState !== 'playing' || ship.explodeTime > 0) return;
    const bx = ship.x + 4/3 * ship.r * Math.cos(ship.a);
    const by = ship.y + 4/3 * ship.r * Math.sin(ship.a);
    bullets.push(createBullet(bx, by, ship.a));
    playSound('shoot');
}

function explodeShip() {
    ship.explodeTime = Math.ceil(FPS * 1.5);
    playSound('explosion');
    for(let i=0; i<30; i++) particles.push(createParticle(ship.x, ship.y, '#ef4444'));
}

function initGame() {
    score = 0; lives = 3; level = 1;
    scoreVal.innerText = score; livesVal.innerText = lives;
    ship = createShip(); spawnAsteroids(3 + level);
    gameState = 'playing';
    startScreen.classList.add('hidden'); gameOverScreen.classList.add('hidden');
    gameLoop();
}

function gameOver() {
    gameState = 'gameover'; finalScore.innerText = score; gameOverScreen.classList.remove('hidden');
}

function update() {
    if (gameState !== 'playing') return;
    const exploding = ship.explodeTime > 0;

    if (!exploding) {
        if (keys.ArrowLeft || touchState.left) ship.a -= SHIP_TURN_SPEED / 180 * Math.PI;
        if (keys.ArrowRight || touchState.right) ship.a += SHIP_TURN_SPEED / 180 * Math.PI;
        if (keys.ArrowUp || touchState.thrust) {
            ship.thrusting = true;
            ship.xv += SHIP_THRUST * Math.cos(ship.a); ship.yv += SHIP_THRUST * Math.sin(ship.a);
        } else ship.thrusting = false;

        ship.x += ship.xv; ship.y += ship.yv; ship.xv *= FRICTION; ship.yv *= FRICTION;
        if (ship.x < -ship.r) ship.x = canvas.width + ship.r; else if (ship.x > canvas.width + ship.r) ship.x = -ship.r;
        if (ship.y < -ship.r) ship.y = canvas.height + ship.r; else if (ship.y > canvas.height + ship.r) ship.y = -ship.r;
    } else {
        ship.explodeTime--;
        if (ship.explodeTime == 0) {
            lives--; livesVal.innerText = lives;
            if (lives <= 0) gameOver(); else ship = createShip();
        }
    }

    asteroids.forEach(a => {
        a.x += a.xv; a.y += a.yv; a.a += 0.02;
        if (a.x < -a.r) a.x = canvas.width + a.r; else if (a.x > canvas.width + a.r) a.x = -a.r;
        if (a.y < -a.r) a.y = canvas.height + a.r; else if (a.y > canvas.height + a.r) a.y = -a.r;
    });

    for (let i = bullets.length - 1; i >= 0; i--) {
        let b = bullets[i]; b.x += b.xv; b.y += b.yv; b.dist += BULLET_SPEED;
        if (b.dist > b.maxDist) { bullets.splice(i, 1); continue; }
        if (b.x < 0) b.x = canvas.width; else if (b.x > canvas.width) b.x = 0;
        if (b.y < 0) b.y = canvas.height; else if (b.y > canvas.height) b.y = 0;

        for (let j = asteroids.length - 1; j >= 0; j--) {
            let a = asteroids[j];
            if (distBetweenPoints(b.x, b.y, a.x, a.y) < a.r) {
                bullets.splice(i, 1); destroyAsteroid(j); break; 
            }
        }
    }

    if (!exploding) {
        for (let i = 0; i < asteroids.length; i++) {
            if (distBetweenPoints(ship.x, ship.y, asteroids[i].x, asteroids[i].y) < ship.r + asteroids[i].r - 5) {
                explodeShip(); destroyAsteroid(i); break;
            }
        }
    }

    for(let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i]; p.x += p.xv; p.y += p.yv; p.life -= p.decay;
        if(p.life <= 0) particles.splice(i, 1);
    }
    
    if (asteroids.length === 0 && !exploding) { level++; spawnAsteroids(3 + level); }
}

function destroyAsteroid(index) {
    let a = asteroids[index];
    for(let i=0; i<5; i++) particles.push(createParticle(a.x, a.y, '#fff'));
    asteroids.splice(index, 1); playSound('explosion');
    if (a.r > 20) { score += 20; asteroids.push(createAsteroid(a.x, a.y, a.r / 2)); asteroids.push(createAsteroid(a.x, a.y, a.r / 2)); }
    else if (a.r > 10) { score += 50; asteroids.push(createAsteroid(a.x, a.y, a.r / 2)); asteroids.push(createAsteroid(a.x, a.y, a.r / 2)); }
    else score += 100;
    scoreVal.innerText = score;
}

function draw() {
    ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => { ctx.fillStyle = `rgba(255, 255, 255, ${p.life})`; ctx.fillRect(p.x, p.y, p.size, p.size); });

    if (gameState === 'playing' || gameState === 'gameover') {
        if (ship.explodeTime === 0) {
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
            let x1 = ship.x + 4/3 * ship.r * Math.cos(ship.a), y1 = ship.y + 4/3 * ship.r * Math.sin(ship.a);
            let x2 = ship.x - ship.r * (2/3 * Math.cos(ship.a) + Math.sin(ship.a)), y2 = ship.y - ship.r * (2/3 * Math.sin(ship.a) - Math.cos(ship.a));
            let x3 = ship.x - ship.r * (2/3 * Math.cos(ship.a) - Math.sin(ship.a)), y3 = ship.y - ship.r * (2/3 * Math.sin(ship.a) + Math.cos(ship.a));
            ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.lineTo(x3, y3); ctx.closePath(); ctx.stroke();
            if (ship.thrusting) {
                ctx.strokeStyle = '#4ade80'; ctx.beginPath(); ctx.moveTo(x2, y2);
                ctx.lineTo(ship.x - ship.r * (5/3 * Math.cos(ship.a)), ship.y - ship.r * (5/3 * Math.sin(ship.a)));
                ctx.lineTo(x3, y3); ctx.stroke();
            }
        }
        ctx.lineWidth = 2;
        asteroids.forEach(a => {
            ctx.strokeStyle = '#fff'; ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.a);
            ctx.strokeRect(-a.r, -a.r, a.r * 2, a.r * 2);
            ctx.fillStyle = '#000'; ctx.fillRect(-a.r + 2, -a.r + 2, a.r * 2 - 4, a.r * 2 - 4); ctx.restore();
        });
        ctx.fillStyle = '#4ade80'; bullets.forEach(b => ctx.fillRect(b.x - 2, b.y - 2, 4, 4));
    }
}

function gameLoop() { update(); draw(); animationId = requestAnimationFrame(gameLoop); }

document.getElementById('start-btn').addEventListener('click', () => { if (audioCtx.state === 'suspended') audioCtx.resume(); initGame(); });
document.getElementById('restart-btn').addEventListener('click', () => initGame());

</script>
</body>
</html>


